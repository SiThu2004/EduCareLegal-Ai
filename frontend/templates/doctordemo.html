<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Doctor Call</title>
  <link href="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.css" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .pulse-animation {
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    .typing-indicator::after {
      content: '...';
      animation: dots 1.5s steps(3, end) infinite;
    }
    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }
    .sidebar {
      position: fixed;
      top: 0;
      right: -400px;
      width: 350px;
      height: 100vh;
      background-color: #1e293b;
      transition: right 0.3s ease;
      z-index: 100;
      box-shadow: -5px 0 15px rgba(0, 0, 0, 0.2);
    }
    .sidebar.open {
      right: 0;
    }
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 99;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    .overlay.active {
      opacity: 1;
      pointer-events: all;
    }
    @media (max-width: 640px) {
      .sidebar {
        width: 85%;
        right: -85%;
      }
    }
    .message-bubble {
      max-width: 80%;
      padding: 0.75rem;
      border-radius: 1rem;
      margin-bottom: 0.5rem;
    }
    .user-message {
      background-color: #3b82f6;
      color: white;
      margin-left: auto;
      border-bottom-right-radius: 0.25rem;
    }
    .doctor-message {
      background-color: #10b981;
      color: white;
      margin-right: auto;
      border-bottom-left-radius: 0.25rem;
    }
  </style>
</head>
<body class="bg-[#0D1B2A] min-h-screen flex items-center justify-center p-4">
  <!-- Overlay for sidebar -->
  <div class="overlay" id="overlay"></div>
  
  <!-- Sidebar for conversation -->
  <div class="sidebar" id="sidebar">
    <div class="p-4 h-full flex flex-col">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-white">Consultation</h2>
        <button id="closeSidebar" class="text-gray-400 hover:text-white">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div id="conversationHistory" class="flex-1 overflow-y-auto pr-2 space-y-2"></div>
    </div>
  </div>

  <!-- Main content -->
  <div class="text-center text-white space-y-6 max-w-md w-full relative">
    <!-- Doctor Avatar with Pulse Animation when listening -->
    <div class="flex justify-center">
      <img src="/static/image/doctor.jpg" alt="Dr. Smith" 
           class="w-32 h-32 rounded-full border-4 border-green-500 object-cover pulse-animation" 
           id="doctorAvatar">
    </div>
    
    <!-- Status Information -->
    <div>
      <h1 class="text-2xl font-bold text-white">Dr. Smith</h1>
      <p class="text-gray-300 text-lg mt-1" id="statusText">Ready for consultation</p>
    </div>
    
    <!-- Controls -->
    <div class="flex justify-center space-x-8 mt-6">
      <!-- Conversation Button -->
      <button id="toggleConversationBtn" class="flex flex-col items-center group">
        <div class="bg-gray-800 hover:bg-gray-700 p-4 rounded-full transition-all duration-300 group-hover:scale-110">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
          </svg>
        </div>
        <span class="text-sm mt-2 text-white">Consultation</span>
      </button>

      <!-- Mute Button -->
      <button id="muteBtn" class="flex flex-col items-center group">
        <div class="bg-gray-800 hover:bg-gray-700 p-4 rounded-full transition-all duration-300 group-hover:scale-110">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="currentColor" viewBox="0 0 24 24" id="micIcon">
            <path d="M12 1a3 3 0 00-3 3v8a3 3 0 106 0V4a3 3 0 00-3-3z" />
            <path d="M19 11a7 7 0 01-14 0H3a9 9 0 0018 0h-2z" />
            <path d="M12 21v-3" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
          </svg>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white hidden" fill="none" viewBox="0 0 24 24" 
               stroke="currentColor" stroke-width="2" id="mutedIcon">
            <path stroke-linecap="round" stroke-linejoin="round" 
                  d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" 
                  clip-rule="evenodd" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2" />
          </svg>
        </div>
        <span class="text-sm mt-2 text-white" id="muteText">Mute</span>
      </button>

      <!-- End Consultation Button -->
      <button id="hangUpBtn" class="flex flex-col items-center group">
        <div class="bg-red-600 hover:bg-red-700 p-4 rounded-full transition-all duration-300 group-hover:scale-110">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24"
            stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </div>
        <span class="text-sm mt-2 text-white">End Call</span>
      </button>
    </div>
    
    <!-- Help Text -->
    <p class="text-gray-400 text-sm mt-6">Press the microphone button to start your consultation</p>
  </div>

  <script>
  // Voice recognition variables
let recognition;
let isMuted = false;
let isProcessing = false;
let audioContext;
let currentAudio = null;

// Voice settings object
let voiceSettings = {
    voiceType: 'default',
    speed: 'normal'
};

// Delete all audio files
async function deleteAudioFiles() {
    try {
        const response = await fetch('/doctor/delete-audio', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const result = await response.json();
        if (response.ok) {
            console.log('Audio files deleted:', result.deleted_files);
        } else {
            console.error('Error deleting audio files:', result.message);
        }
    } catch (error) {
        console.error('Error deleting audio files:', error);
    }
}

// Initialize when page loads
async function initialize() {
    try {
        // Load saved settings
        const savedSettings = JSON.parse(localStorage.getItem('doctorVoiceSettings')) || {
            voice: 'default',
            speed: 'normal'
        };
        voiceSettings.voiceType = savedSettings.voice;
        voiceSettings.speed = savedSettings.speed;

        // Delete all audio files on page load
        await deleteAudioFiles();
        
        // Initialize Web Audio API
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        // Check microphone permission
        await navigator.mediaDevices.getUserMedia({ audio: true });
        
        // Set up conversation toggle button
        document.getElementById('toggleConversationBtn').addEventListener('click', toggleSidebar);
        document.getElementById('closeSidebar').addEventListener('click', toggleSidebar);
        document.getElementById('overlay').addEventListener('click', toggleSidebar);
        
        // Delete audio files when page is about to unload (refresh/close)
        window.addEventListener('beforeunload', function() {
            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/doctor/delete-audio', false);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.send();
        });
        
        // Start recognition
        startRecognition();
    } catch (error) {
        console.error("Initialization error:", error);
        updateStatus("Error initializing microphone");
        showError("Please allow microphone access to use this feature.");
    }
}

// Toggle sidebar visibility
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    sidebar.classList.toggle('open');
    overlay.classList.toggle('active');
}

// Start voice recognition
function startRecognition() {
    if (isMuted || isProcessing) return;

    try {
        recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = "en-US";
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;
        recognition.continuous = false;

        recognition.onstart = () => {
            updateStatus("Listening...");
            document.getElementById('doctorAvatar').classList.add('pulse-animation');
        };

        recognition.onresult = async (event) => {
            isProcessing = true;
            const transcript = event.results[0][0].transcript.trim();
            console.log("Patient said:", transcript);
            
            addToConversation('user', transcript);
            updateStatus("Analyzing your concern...");

            try {
                await sendVoiceMessage(transcript);
            } catch (error) {
                console.error("Error:", error);
                updateStatus("Error processing request");
                addToConversation('doctor', "I'm sorry, I encountered a technical issue. Please try again.");
            } finally {
                isProcessing = false;
                if (!isMuted) {
                    setTimeout(startRecognition, 1000);
                }
            }
        };

        recognition.onerror = (event) => {
            console.error("Recognition error:", event.error);
            if (event.error === 'not-allowed') {
                showError("Microphone access denied. Please allow microphone use for consultation.");
            }
            updateStatus("Error listening");
            isProcessing = false;
            if (!isMuted && event.error !== "aborted") {
                setTimeout(startRecognition, 2000);
            }
        };

        recognition.onend = () => {
            document.getElementById('doctorAvatar').classList.remove('pulse-animation');
            if (!isMuted && !isProcessing) {
                updateStatus("Ready for consultation");
                setTimeout(startRecognition, 500);
            }
        };

        recognition.start();
    } catch (error) {
        console.error("Recognition setup error:", error);
        updateStatus("Setup error");
        isProcessing = false;
    }
}

// Send voice message to server
async function sendVoiceMessage(message) {
    if (!message) return;

    try {
        const typingId = addToConversation('doctor', '<span class="typing-indicator">Analyzing</span>', true);
        
        const response = await fetch('/doctor/call', {
            method: 'POST',
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
                message,
                voice: voiceSettings.voiceType,
                speed: voiceSettings.speed
            })
        });

        if (!response.ok) {
            throw new Error(`Server error: ${response.status}`);
        }

        const data = await response.json();
        console.log("Doctor response:", data.text);
        
        updateConversationMessage(typingId, 'doctor', data.text);
        updateStatus("Doctor is responding...");
        
        if (data.audio) {
            await playAudioResponse(data.audio);
        }
        
        updateStatus("Ready for consultation");
    } catch (error) {
        console.error("Communication error:", error);
        updateStatus("Connection error");
        throw error;
    }
}

// Play audio response
async function playAudioResponse(audioUrl) {
    return new Promise((resolve, reject) => {
        if (currentAudio) {
            currentAudio.pause();
            currentAudio = null;
        }
        
        currentAudio = new Audio(audioUrl);
        currentAudio.onended = () => resolve();
        currentAudio.onerror = (error) => {
            console.error("Audio error:", error);
            reject(error);
        };
        
        currentAudio.play().catch(error => {
            console.error("Playback failed:", error);
            reject(error);
        });
    });
}

// Add message to conversation history
function addToConversation(sender, message, isTemporary = false) {
    const conversation = document.getElementById('conversationHistory');
    const messageId = 'msg-' + Date.now();
    
    const messageDiv = document.createElement('div');
    messageDiv.id = messageId;
    messageDiv.className = `message-bubble ${sender === 'user' ? 'user-message' : 'doctor-message'}`;
    messageDiv.innerHTML = `
        <div class="font-semibold">${sender === 'user' ? 'You' : 'Dr. Smith'}</div>
        <div class="mt-1">${message}</div>
    `;
    
    conversation.appendChild(messageDiv);
    conversation.scrollTop = conversation.scrollHeight;
    
    return isTemporary ? messageId : null;
}

// Update existing conversation message
function updateConversationMessage(id, sender, newMessage) {
    const messageDiv = document.getElementById(id);
    if (messageDiv) {
        messageDiv.innerHTML = `
            <div class="font-semibold">${sender === 'user' ? 'You' : 'Dr. Smith'}</div>
            <div class="mt-1">${newMessage}</div>
        `;
    }
}

// Update status text
function updateStatus(text) {
    document.getElementById('statusText').textContent = text;
}

// Show error message
function showError(message) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'bg-red-900 text-white p-3 rounded mb-3';
    errorDiv.textContent = message;
    document.getElementById('conversationHistory').prepend(errorDiv);
}

// Mute button click handler
document.getElementById("muteBtn").addEventListener("click", () => {
    isMuted = !isMuted;
    if (isMuted) {
        if (recognition) recognition.stop();
        document.getElementById("micIcon").classList.add('hidden');
        document.getElementById("mutedIcon").classList.remove('hidden');
        document.getElementById("muteText").textContent = "Unmute";
        updateStatus("Microphone muted");
    } else {
        document.getElementById("micIcon").classList.remove('hidden');
        document.getElementById("mutedIcon").classList.add('hidden');
        document.getElementById("muteText").textContent = "Mute";
        updateStatus("Starting...");
        startRecognition();
    }
});

// Hang up button click handler
document.getElementById("hangUpBtn").addEventListener("click", () => {
    if (recognition) recognition.abort();
    if (currentAudio) currentAudio.pause();
    window.location.href = "/doctor";
});

// Initialize the application
window.onload = initialize;
  </script>
</body>
</html>