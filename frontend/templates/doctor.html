{% extends "index.html" %}

{% block title %}Doctor Chat{% endblock %}

{% block content %}

<!-- Right Sidebar for settings -->
<div class="right-sidebar" id="rightSidebar">
   <div class="p-6">
      <div class="flex justify-between items-center mb-6">
         <h2 class="text-xl font-bold">Doctor Settings</h2>
         <button id="closeRightSidebar" class="text-gray-500 hover:text-gray-700">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
               stroke="currentColor">
               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
         </button>
      </div>

      <div class="space-y-6">
         <!-- Character Info -->
         <div class="flex items-center space-x-4">
            <img src="/static/image/doctor.jpg" alt="Doctor" class="w-16 h-16 rounded-full">
            <div>
               <h3 class="font-semibold">Doctor Kyaw</h3>
               <p class="text-sm text-gray-500">Medical Professional</p>
            </div>
         </div>

         <!-- Voice Settings -->
         <!-- Voice Settings Section ·ÄÄ·Ä≠·ÄØ·Äí·ÄÆ·Äú·Ä≠·ÄØ·Äï·Äº·ÄÑ·Ä∫·Äï·Ä´ -->
         <div class="space-y-4">
            <div>
               <h4 class="font-medium mb-2">Voice Type</h4>
               <select id="voiceSelect" class="w-full p-2 border border-gray-300 rounded">
                  <option value="default">Christopher</option>
                  <option value="male2">Eric</option>
                  <option value="male3">Brandon</option>
                  <!-- <option value="myanmar">Myanmar Voice (Thiha)</option> -->
               </select>
            </div>

            <div>
               <h4 class="font-medium mb-2">Speaking Speed</h4>
               <select id="speedSelect" class="w-full p-2 border border-gray-300 rounded">
                  <option value="slow">Slow</option>
                  <option value="normal" selected>Normal</option>
                  <option value="fast">Fast</option>
               </select>
            </div>

            <!-- Voice Test Button ·Äë·Ää·Ä∑·Ä∫·Äï·Ä´ -->
            <!-- <div>
               <h4 class="font-medium mb-2">Test Voice</h4>
               <button id="testVoiceBtn"
                  class="w-full py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition text-sm">
                  Test Selected Voice
               </button>
               <p class="text-xs text-gray-500 mt-1">Click to test the current voice settings</p>
            </div> -->
         </div>
         <!-- Interaction History -->
         <div>
            <h4 class="font-medium mb-2">Interaction History</h4>
            <div class="bg-gray-100 p-3 rounded">
               <p class="text-sm" id="historyCount">Loading...</p>
            </div>
         </div>

         <!-- Current Settings Display -->
         <div>
            <!-- <h4 class="font-medium mb-2">Pin Message</h4>
            <div class="bg-gray-100 p-3 rounded">
               <p class="text-sm">No pinned messages</p>
            </div> -->
         </div>
      </div>

      <button id="saveSettingsBtn"
         class="w-full py-2 bg-green-500 text-white rounded hover:bg-green-600 transition mt-4">
         Save Settings
      </button>
   </div>
</div>

<!-- Overlay -->
<div class="overlay fixed inset-0 bg-black bg-opacity-50 z-40" id="overlay"></div>

<!-- Main Content -->
<main class="md:ml-64 min-h-screen bg-white p-4 sm:p-6 transition-all duration-300">
   <!-- Header -->
   <header
      class="sticky top-0 z-40 flex flex-wrap items-center justify-between gap-3 mb-4 border-b border-gray-300 pb-4 bg-white px-2 sm:px-4">
      <div class="flex items-center space-x-3">
         <img src="/image/doctor.jpg" alt="Avatar" class="w-8 h-8 rounded-full border border-gray-300">
         <h1 class="text-lg sm:text-xl font-semibold">Doctor Kyaw</h1>
      </div>
      <div class="flex items-center space-x-3">
         <a href="/doctorcall">
            <button class="p-2 rounded-full border border-gray-400 hover:bg-gray-100 hover:border-green-500 transition">
               <svg class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                     d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72 12.17 12.17 0 00.7 2.81 2 2 0 01-.45 2.11L8 10a16 16 0 006 6l1.36-1.36a2 2 0 012.11-.45 12.17 12.17 0 002.81.7A2 2 0 0122 16.92z" />
               </svg>
            </button>
         </a>

         <!-- Character setting button -->
         <button id="openRightSidebar"
            class="p-2 rounded-full border border-gray-400 hover:bg-gray-100 hover:border-red-500 transition">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
               <circle cx="5" cy="12" r="2" />
               <circle cx="12" cy="12" r="2" />
               <circle cx="19" cy="12" r="2" />
            </svg>
         </button>
      </div>
   </header>

   <!-- Main Chat Section -->
   <div class="flex flex-col items-center px-2 sm:px-0">
      <img src="/image/doctor.jpg" alt="Profile" class="w-20 h-20 rounded-full shadow mb-4">
      <h2 class="text-2xl font-semibold mb-1">Doctor Kyaw</h2>

      <!-- Chat Box -->
      <div id="chatBox" class="w-full max-w-lg space-y-4 mt-6 overflow-y-auto no-scrollbar  rounded-lg p-2 sm:p-4 "
         style="height: 60vh;">
         <!-- Default message -->
         <div class="bg-gray-100 rounded-2xl p-4 shadow flex items-start space-x-3">
            <img src="/image/doctor.jpg" alt="Avatar" class="w-10 h-10 rounded-full">
            <div>
               <p class="font-semibold text-sm mb-1">Doctor Kyaw</p>
               <p class="text-sm text-gray-800">
                  Hello! I'm Dr. Kyaw, a medical professional. I'm here to help answer
                  your health-related questions. For serious concerns, please consult a healthcare provider in person.
               </p>
            </div>
         </div>
      </div>

      <!-- Input -->
      <!-- <div class="sticky bottom-4 w-full max-w-lg mt-6 px-2 sm:px-0">
         <div class="flex items-center rounded-full border border-gray-300 shadow p-2 bg-white">
            <input id="userInput" type="text" placeholder="Describe your health concern‚Ä¶"
               class="flex-grow px-4 py-2 rounded-full focus:outline-none text-sm bg-white text-gray-800" />
            <button onclick="sendMessage()" class="p-2 hover:bg-gray-200 rounded-full">
               <svg class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M22 2L11 13" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                     d="M22 2L15 22L11 13L2 9L22 2Z" />
               </svg>
            </button>
         </div>
      </div> -->


      <!-- Input -->
      <div class="sticky bottom-4 w-full max-w-lg mt-6 px-2 sm:px-0">
         <div class="flex items-center rounded-full border border-gray-300 shadow p-2 bg-white">
            <input id="userInput" type="text" placeholder="Describe your health concern‚Ä¶"
               class="flex-grow px-4 py-2 rounded-full focus:outline-none text-sm bg-white text-gray-800" />

            <!-- Mic Button -->
            <button id="micBtn" class="p-2 hover:bg-gray-200 rounded-full mr-1 transition-all duration-300">
               <svg class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                     d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
               </svg>
            </button>

            <!-- Send Button -->
            <button onclick="sendMessage()" class="p-2 hover:bg-gray-200 rounded-full transition-all duration-300">
               <svg class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M22 2L11 13" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                     d="M22 2L15 22L11 13L2 9L22 2Z" />
               </svg>
            </button>
         </div>
      </div>
   </div>
</main>

<!-- Scripts -->
<!-- Scripts -->
<script>
   // Global variables
   let chatHistoryLoaded = false;
   let currentSettings = {
      voice: 'default',
      speed: 'normal',
      autoVoice: false
   };

   // Voice Recognition Variables
   let recognition;
   let isListening = false;
   let currentLang = "my-MM"; // Myanmar language code

   // Load settings from localStorage
   function loadSettings() {
      try {
         const saved = JSON.parse(localStorage.getItem('doctorSettings')) || {
            voice: 'default',
            speed: 'normal',
            autoVoice: false
         };
         currentSettings = saved;
         console.log(' Loaded doctor settings:', currentSettings);
         updateSettingsDisplay();
         return saved;
      } catch (e) {
         console.error(' Error loading doctor settings:', e);
         return { voice: 'default', speed: 'normal', autoVoice: false };
      }
   }

   // Save settings to localStorage
   function saveSettings(settings) {
      try {
         localStorage.setItem('doctorSettings', JSON.stringify(settings));
         currentSettings = settings;
         updateSettingsDisplay();
         console.log(' Saved doctor settings:', currentSettings);
         alert('Doctor settings saved successfully!');
      } catch (e) {
         console.error(' Error saving doctor settings:', e);
         alert('Error saving settings!');
      }
   }

   // Update settings display in sidebar
   function updateSettingsDisplay() {
      const voiceText = {
         'default': 'Male Voice 1 (Christopher)',
         'male2': 'Male Voice 2 (Eric)',
         'male3': 'Male Voice 3 (Brandon)',
         'myanmar': 'Myanmar Voice (Thiha)'
      };

      const speedText = {
         'slow': 'Slow',
         'normal': 'Normal',
         'fast': 'Fast'
      };

      const displayElement = document.getElementById('currentSettings');
      if (displayElement) {
         displayElement.innerHTML = `Voice: ${voiceText[currentSettings.voice]}<br>Speed: ${speedText[currentSettings.speed]}<br>Auto Voice: ${currentSettings.autoVoice ? 'On' : 'Off'}`;
      }
   }

   

   // Initialize voice recognition
   function initVoiceRecognition() {
      if ('webkitSpeechRecognition' in window) {
         recognition = new webkitSpeechRecognition();
         recognition.continuous = false;
         recognition.interimResults = false;
         recognition.lang = currentLang;

         recognition.onstart = function () {
            console.log(" Voice recognition started - Myanmar");
            isListening = true;
            updateMicButton();
            showListeningIndicator();
         };

         recognition.onresult = function (event) {
            const transcript = event.results[0][0].transcript.trim();
            console.log("·Äô·Äº·Äî·Ä∫·Äô·Ä¨·ÄÖ·ÄÄ·Ä¨·Ä∏ ·ÄÄ·Äº·Ä¨·Ä∏·Äú·Ä≠·ÄØ·ÄÄ·Ä∫·Äõ·Äû·Ää·Ä∫:", transcript);

            // Add the recognized text to input field (NO AUTO SEND)
            document.getElementById('userInput').value = transcript;

            hideListeningIndicator();

            // Show instruction to click send button
            showSendInstruction();
         };

         recognition.onerror = function (event) {
            console.error("Voice recognition error:", event.error);
            isListening = false;
            updateMicButton();
            hideListeningIndicator();
            hideSendInstruction();

            if (event.error === 'not-allowed') {
               alert("·Äô·Ä≠·ÄØ·ÄÄ·Ä∫·ÄÅ·Äõ·Ä≠·ÄØ·Äñ·ÄØ·Äî·Ä∫·Ä∏ ·ÄÅ·ÄΩ·ÄÑ·Ä∑·Ä∫·Äï·Äº·ÄØ·ÄÅ·Äª·ÄÄ·Ä∫ ·Äú·Ä≠·ÄØ·Ä°·Äï·Ä∫·Äï·Ä´·Äû·Ää·Ä∫·Åã ·ÄÄ·Äª·Ä±·Ä∏·Äá·Ä∞·Ä∏·Äï·Äº·ÄØ·Åç browser setting ·Äô·Äæ microphone permission ·Äï·Ä±·Ä∏·Äï·Ä´·Åã");
            } else if (event.error === 'no-speech') {
               alert("·ÄÖ·ÄÄ·Ä¨·Ä∏·Äï·Äº·Ä±·Ä¨·Äû·Ä∂ ·Äô·ÄÄ·Äº·Ä¨·Ä∏·Äõ·Äï·Ä´·Åã ·Äë·Äï·Ä∫·Äô·Ä∂·ÄÄ·Äº·Ä≠·ÄØ·Ä∏·ÄÖ·Ä¨·Ä∏·ÄÄ·Äº·Ää·Ä∑·Ä∫·Äï·Ä´·Åã");
            }
         };

         recognition.onend = function () {
            console.log(" Voice recognition ended");
            isListening = false;
            updateMicButton();
            hideListeningIndicator();
         };
      } else {
         console.error("Browser doesn't support speech recognition");
         alert("·Äû·ÄÑ·Ä∑·Ä∫ browser ·Äû·Ää·Ä∫ voice recognition ·ÄÄ·Ä≠·ÄØ ·Äô·Äï·Ä∂·Ä∑·Äï·Ä≠·ÄØ·Ä∏·Äï·Ä´·Åã Chrome browser ·ÄÄ·Ä≠·ÄØ ·Ä°·Äû·ÄØ·Ä∂·Ä∏·Äï·Äº·ÄØ·Äï·Ä´·Åã");
      }
   }

   // Toggle microphone
   function toggleMic() {
      if (!recognition) {
         initVoiceRecognition();
      }

      if (isListening) {
         recognition.stop();
         hideSendInstruction();
      } else {
         try {
            // Clear any previous instruction
            hideSendInstruction();
            recognition.start();
         } catch (error) {
            console.error("Error starting recognition:", error);
            initVoiceRecognition();
            recognition.start();
         }
      }
   }

   // Update mic button appearance
   function updateMicButton() {
      const micBtn = document.getElementById('micBtn');
      if (!micBtn) return;

      const micIcon = micBtn.querySelector('svg');

      if (isListening) {
         // Listening state - red color with animation
         micBtn.classList.add('bg-red-100', 'border-red-400', 'recording-pulse');
         micBtn.classList.remove('hover:bg-gray-200');
         micIcon.classList.add('text-red-600');
         micIcon.classList.remove('text-gray-600');
      } else {
         // Not listening state
         micBtn.classList.remove('bg-red-100', 'border-red-400', 'recording-pulse');
         micBtn.classList.add('hover:bg-gray-200');
         micIcon.classList.remove('text-red-600');
         micIcon.classList.add('text-gray-600');
      }
   }

   // Show listening indicator
   // function showListeningIndicator() {
   //    let indicator = document.getElementById('listeningIndicator');
   //    if (!indicator) {
   //       indicator = document.createElement('div');
   //       indicator.id = 'listeningIndicator';
   //       indicator.className = 'fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-4 py-2 rounded-full shadow-lg z-50';
   //       indicator.innerHTML = `
   //          <div class="flex items-center space-x-2">
   //              <div class="w-2 h-2 bg-white rounded-full animate-pulse"></div>
   //              <span class="text-sm">üé§ ·Äô·Äº·Äî·Ä∫·Äô·Ä¨·ÄÖ·ÄÄ·Ä¨·Ä∏ ·Äî·Ä¨·Ä∏·Äë·Ä±·Ä¨·ÄÑ·Ä∫·Äî·Ä±·Äû·Ää·Ä∫...</span>
   //          </div>
   //      `;
   //       document.body.appendChild(indicator);
   //    }
   //    indicator.style.display = 'block';
   // }

   // Hide listening indicator
   function hideListeningIndicator() {
      const indicator = document.getElementById('listeningIndicator');
      if (indicator) {
         indicator.style.display = 'none';
      }
   }

   // Show send instruction
   // function showSendInstruction() {
   //    let instruction = document.getElementById('sendInstruction');
   //    if (!instruction) {
   //       instruction = document.createElement('div');
   //       instruction.id = 'sendInstruction';
   //       instruction.className = 'fixed bottom-32 left-1/2 transform -translate-x-1/2 bg-blue-500 text-white px-4 py-2 rounded-full shadow-lg z-50';
   //       instruction.innerHTML = `
   //          <div class="flex items-center space-x-2">
   //              <span class="text-sm">üìù Send ·ÄÅ·Äú·ÄØ·Äê·Ä∫·ÄÄ·Ä≠·ÄØ ·Äî·Äæ·Ä≠·Äï·Ä∫·Äï·Ä´</span>
   //          </div>
   //      `;
   //       document.body.appendChild(instruction);
   //    }
   //    instruction.style.display = 'block';

   //    // Auto hide after 5 seconds
   //    setTimeout(() => {
   //       hideSendInstruction();
   //    }, 5000);
   // }

   // Hide send instruction
   function hideSendInstruction() {
      const instruction = document.getElementById('sendInstruction');
      if (instruction) {
         instruction.style.display = 'none';
      }
   }

   // Setup event listeners for voice recognition
   function setupVoiceRecognition() {
      const micBtn = document.getElementById('micBtn');
      if (micBtn) {
         micBtn.addEventListener('click', toggleMic);
      }

      // Initialize voice recognition
      initVoiceRecognition();
   }

   

   // Load everything when page loads
   document.addEventListener('DOMContentLoaded', function () {
      console.log(" Doctor page loaded");
      loadSettings();
      loadChatHistory();
      setupVoiceRecognition();

      // Setup enter key for sending message
      document.getElementById('userInput').addEventListener('keypress', function (e) {
         if (e.key === 'Enter') {
            sendMessage();
         }
      });

      // Setup sidebar events
      setupSidebarEvents();
   });

   // Setup sidebar events
   function setupSidebarEvents() {
      // Open sidebar
      document.getElementById('openRightSidebar').addEventListener('click', function () {
         document.getElementById('rightSidebar').classList.add('open');
         document.getElementById('overlay').classList.add('active');

         // Load current settings to form
         document.getElementById('voiceSelect').value = currentSettings.voice;
         document.getElementById('speedSelect').value = currentSettings.speed;

         
         if (chatHistoryLoaded) {
            updateHistoryCountFromChats();
         }
      });

      // Close sidebar - X button
      document.getElementById('closeRightSidebar').addEventListener('click', function () {
         closeSidebar();
      });

      // Close sidebar - Overlay click
      document.getElementById('overlay').addEventListener('click', function () {
         closeSidebar();
      });

      // Save settings button
      document.getElementById('saveSettingsBtn').addEventListener('click', function () {
         const voiceType = document.getElementById('voiceSelect').value;
         const speed = document.getElementById('speedSelect').value;

         console.log(' Saving new settings:', { voice: voiceType, speed: speed });
         saveSettings({
            voice: voiceType,
            speed: speed,
            autoVoice: false
         });

         closeSidebar();
      });
   }

   // Close sidebar function
   function closeSidebar() {
      document.getElementById('rightSidebar').classList.remove('open');
      document.getElementById('overlay').classList.remove('active');
   }

   // Update history count from current chats
   function updateHistoryCountFromChats() {
      const chatBox = document.getElementById('chatBox');
      const userMessages = chatBox.querySelectorAll('.bg-blue-100');
      updateHistoryCount(userMessages.length);
   }

   // Function to load chat history from server
   async function loadChatHistory() {
      try {
         console.log(" Loading doctor chat history...");
         const response = await fetch('/doctor/chat-history-api');

         if (response.ok) {
            const data = await response.json();
            console.log(" Doctor chat history loaded:", data.chats?.length || 0, "messages");

            if (data.chats && data.chats.length > 0) {
               displayChatHistory(data.chats);
               updateHistoryCount(data.chats.length);
            } else {
               console.log(" No previous doctor chat history found");
               updateHistoryCount(0);
            }
            chatHistoryLoaded = true;
         } else {
            console.error(" Failed to load doctor chat history:", response.status);
         }
      } catch (error) {
         console.error(" Error loading doctor chat history:", error);
      }
   }

   // Function to display chat history in the chat box
   function displayChatHistory(chats) {
      const chatBox = document.getElementById('chatBox');

      // Clear only the default message if we have actual chats
      if (chats.length > 0) {
         const defaultMessage = chatBox.querySelector('.bg-gray-100');
         chatBox.innerHTML = '';
         if (defaultMessage) {
            chatBox.appendChild(defaultMessage);
         }
      }

      // Add all chat messages
      chats.forEach(chat => {
         if (chat.user_message && chat.bot_reply) {
            addUserMessageToChat(chat.user_message, false);
            addDoctorMessageToChat(chat.bot_reply, false);
         }
      });

      scrollToBottom();
   }

   // Function to update history count in sidebar
   function updateHistoryCount(count) {
      const historyElement = document.getElementById('historyCount');
      if (historyElement) {
         historyElement.textContent = `${count} medical consultations`;
      }
   }

   // Scroll to bottom of chat
   function scrollToBottom() {
      const chatBox = document.getElementById('chatBox');
      chatBox.scrollTop = chatBox.scrollHeight;
   }

   // Main send message function
   async function sendMessage() {
      const input = document.getElementById('userInput');
      const message = input.value.trim();
      if (!message) {
         // Show warning if input is empty
         showEmptyInputWarning();
         return;
      }

      // Clear input immediately
      input.value = '';

      // Hide any instructions
      hideSendInstruction();

      console.log(" Sending message to doctor:", message);
      console.log(" Current voice settings:", currentSettings);

      addUserMessageToChat(message);

      // Add typing indicator
      const typingId = 'typing-' + Date.now();
      addDoctorTypingIndicator(typingId);

      try {
         // Step 1: Get text response from doctor
         const chatResponse = await fetch('/doctor/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: message })
         });

         // Remove typing indicator
         removeTypingIndicator(typingId);

         if (chatResponse.ok) {
            const data = await chatResponse.json();
            console.log(" Doctor text reply received");
            addDoctorMessageToChat(data.reply);

            // Update history count
            if (chatHistoryLoaded) {
               updateHistoryCountFromChats();
            }
         } else {
            const errorText = await chatResponse.text();
            console.error(" Server error:", errorText);
            addDoctorMessageToChat("Something went wrong. Please try again.");
         }
      } catch (error) {
         removeTypingIndicator(typingId);
         console.error(' Network error:', error);
         addDoctorMessageToChat("Connection error. Please check your internet.");
      }
   }

   // Show empty input warning
   function showEmptyInputWarning() {
      let warning = document.getElementById('emptyInputWarning');
      if (!warning) {
         warning = document.createElement('div');
         warning.id = 'emptyInputWarning';
         warning.className = 'fixed bottom-32 left-1/2 transform -translate-x-1/2 bg-yellow-500 text-white px-4 py-2 rounded-full shadow-lg z-50';
         warning.innerHTML = `
            <div class="flex items-center space-x-2">
                <span class="text-sm">‚ö†Ô∏è ·ÄÖ·Ä¨·Äû·Ä¨·Ä∏·Äë·Ää·Ä∑·Ä∫·Äï·Ä´ ·Äû·Ä≠·ÄØ·Ä∑·Äô·Äü·ÄØ·Äê·Ä∫ ·Äô·Ä≠·ÄØ·ÄÄ·Ä∫·ÄÅ·Äõ·Ä≠·ÄØ·Äñ·ÄØ·Äî·Ä∫·Ä∏·Äî·Äæ·Ä≠·Äï·Ä∫·Äï·Ä´</span>
            </div>
        `;
         document.body.appendChild(warning);
      }
      warning.style.display = 'block';

      // Auto hide after 3 seconds
      setTimeout(() => {
         warning.style.display = 'none';
      }, 3000);
   }

   // Chat UI functions
   function addUserMessageToChat(message, scroll = true) {
      const chatBox = document.getElementById('chatBox');
      const userMsg = `
        <div class="flex justify-end mb-4">
            <div class="flex flex-col items-end space-y-1 max-w-[85%]">
                <div class="bg-blue-100 text-gray-800 rounded-2xl p-4 shadow-sm">
                    <p class="text-sm leading-relaxed">${message}</p>
                </div>
                <span class="text-xs text-gray-500">${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
            </div>
        </div>
    `;
      chatBox.insertAdjacentHTML('beforeend', userMsg);
      if (scroll) scrollToBottom();
   }

   function addDoctorTypingIndicator(id) {
      const chatBox = document.getElementById('chatBox');
      const typingMsg = `
        <div id="${id}" class="flex items-start space-x-3 mb-4">
            <img src="/static/image/doctor.jpg" alt="Avatar" class="w-10 h-10 rounded-full flex-shrink-0" />
            <div class="bg-gray-100 rounded-2xl p-4 shadow-sm max-w-[85%]">
                <p class="font-semibold text-sm mb-1">Doctor Kyaw</p>
                <div class="flex space-x-1">
                    <p class="text-sm text-gray-500 italic">Typing...</p>
                </div> 
            </div>
        </div>
    `;
      chatBox.insertAdjacentHTML('beforeend', typingMsg);
      scrollToBottom();
   }

   function removeTypingIndicator(id) {
      const typingElement = document.getElementById(id);
      if (typingElement) typingElement.remove();
   }

   function addDoctorMessageToChat(message, scroll = true) {
      const chatBox = document.getElementById('chatBox');
      const doctorMsg = `
        <div class="flex items-start space-x-3 mb-4">
            <img src="/static/image/doctor.jpg" alt="Avatar" class="w-10 h-10 rounded-full flex-shrink-0" />
            <div class="bg-gray-100 rounded-2xl p-4 shadow-sm max-w-[85%]">
                <p class="font-semibold text-sm mb-2">Doctor Kyaw</p>
                <p class="text-sm text-gray-800 leading-relaxed">${message}</p>
                <span class="text-xs text-gray-500 mt-2 block">${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
            </div>
        </div>
    `;
      chatBox.insertAdjacentHTML('beforeend', doctorMsg);
      if (scroll) scrollToBottom();
   }

   // Clean up audio files
   window.addEventListener('load', async function () {
      try {
         await fetch('/doctor/clean-audio', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
         });
      } catch (error) {
         console.error('Error cleaning audio files:', error);
      }
   });

   // =========================
   // UTILITY FUNCTIONS
   // =========================

   // Stop voice recognition when leaving page
   window.addEventListener('beforeunload', function () {
      if (recognition && isListening) {
         recognition.stop();
      }
   });

   // Handle page visibility change
   document.addEventListener('visibilitychange', function () {
      if (document.hidden && recognition && isListening) {
         recognition.stop();
      }
   });
</script>

<!-- CSS Styles - Hide Scroll Bar -->
<style>
   .right-sidebar {
      transform: translateX(100%);
      transition: transform 0.3s ease-in-out;
   }

   .right-sidebar.open {
      transform: translateX(0);
   }

   .overlay {
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease-in-out;
   }

   .overlay.active {
      opacity: 1;
      visibility: visible;
   }

   .no-scrollbar::-webkit-scrollbar {
      display: none;
   }

   .no-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
   }

   @media (max-width: 768px) {
      main {
         margin-left: 0 !important;
         padding: 1rem;
      }

      #chatBox {
         height: 55vh;
      }

      .right-sidebar {
         width: 100%;
      }
   }


   .right-sidebar.open {
      transform: translateX(0);
   }

   .overlay {
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease-in-out;
   }

   .overlay.active {
      opacity: 1;
      visibility: visible;
   }

   /* Chat box fixed height and scroll - Hide scroll bar */
   #chatBox {
      height: 60vh;
      overflow-y: auto;
   }

   /* Hide scrollbar for Chrome, Safari and Opera */
   .no-scrollbar::-webkit-scrollbar {
      display: none;
   }

   /* Add to your existing CSS */
   .bg-green-50 {
      background-color: #f0fdf4;
   }

   .border-green-200 {
      border-color: #bbf7d0;
   }

   .text-green-700 {
      color: #15803d;
   }

   /* Test button animation */
   #testVoiceBtn:active {
      transform: scale(0.95);
   }

   /* Hide scrollbar for IE, Edge and Firefox */
   .no-scrollbar {
      -ms-overflow-style: none;
      /* IE and Edge */
      scrollbar-width: none;
      /* Firefox */
   }

   /* Sticky message input */
   .sticky {
      position: sticky;
      bottom: 24px;
      background: white;
      z-index: 10;
   }
</style>

{% endblock %}